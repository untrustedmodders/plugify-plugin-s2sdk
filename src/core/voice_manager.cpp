#include "voice_manager.hpp"
#include "player_manager.hpp"

#include <core/sdk/schema.h>
#include <core/sdk/entity/cbaseentity.h>

poly::ReturnAction CVoiceManager::Hook_SetClientListening(poly::Params& params, int count, poly::Return& ret)
{
	// CPlayerSlot iReceiver, CPlayerSlot iSender, bool bListen
	auto iReceiver = (CPlayerSlot)poly::GetArgument<int>(params, 1);
	auto iSender = (CPlayerSlot)poly::GetArgument<int>(params, 2);
	//auto bListen = poly::GetArgument<bool>(params, 3);

	auto pReceiver = g_PlayerManager.GetPlayerBySlot(iReceiver.Get());
	auto pSender = g_PlayerManager.GetPlayerBySlot(iSender.Get());

	if (pReceiver && pSender)
	{
		auto listenOverride = pReceiver->GetListen(iSender);
		auto senderFlags = pSender->GetVoiceFlags();
		auto receiverFlags = pReceiver->GetVoiceFlags();

		if (pReceiver->m_selfMutes.Get(iSender.Get()))
		{
			poly::SetArgument<bool>(params, 3, false);
			return poly::ReturnAction::Handled;
		}

		if (senderFlags & Speak_Muted)
		{
			poly::SetArgument<bool>(params, 3, false);
			return poly::ReturnAction::Handled;
		}

		if (listenOverride == Listen_Mute)
		{
			poly::SetArgument<bool>(params, 3, false);
			return poly::ReturnAction::Handled;
		}

		if (listenOverride == Listen_Hear)
		{
			poly::SetArgument<bool>(params, 3, true);
			return poly::ReturnAction::Handled;
		}

		if ((senderFlags & Speak_All) || (receiverFlags & Speak_ListenAll))
		{
			poly::SetArgument<bool>(params, 3, true);
			return poly::ReturnAction::Handled;
		}

		if ((senderFlags & Speak_Team) || (receiverFlags & Speak_ListenTeam))
		{
			CBaseEntity* pReceiverController = static_cast<CBaseEntity*>(g_pEntitySystem->GetEntityInstance(CEntityIndex(iReceiver.Get() + 1)));
			CBaseEntity* pSenderController = static_cast<CBaseEntity*>(g_pEntitySystem->GetEntityInstance(CEntityIndex(iSender.Get() + 1)));

			if (pReceiverController && pSenderController)
			{
				poly::SetArgument<bool>(params, 3, pReceiverController->m_iTeamNum() == pSenderController->m_iTeamNum());
				return poly::ReturnAction::Handled;
			}
		}
	}

	return poly::ReturnAction::Ignored;
}